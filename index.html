<!DOCTYPE html>
<html>
<head>
	<title>ColorsGame</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript">
		$(document).bind('mobileinit',function(){
			$.mobile.changePage.defaults.changeHash = false;
			$.mobile.hashListeningEnabled = false;
			$.mobile.pushStateEnabled = false;
		});
	</script>
	<script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
	<!-- <script type="text/javascript" src="js/jquery.touchSwipe.min.js"></script>-->
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link href='https://fonts.googleapis.com/css?family=Lato:400,700,300' rel='stylesheet' type='text/css'>
	<meta charset="utf-8">

	<script type="text/javascript">
		$(document).ready(function(){

				//General Variables
				var cols = 3; //Should be odd
				var rows = Math.floor($(window).height() / 80);
				var game = $("#gameTable").eq(0);
				var lvl = 1;
				var points = 0;
				var toSelect = 0;
				var colorsList =  [{"center":"#F7A7A6","side":"#F48B94"},{"center":"#DBEBC2","side":"#ACDBC9"}, {"center":"#ACC3DB","side":"#ACCADB"}, {"center":"#EAC2E7","side":"#F989F0"}, {"center":"#FFD1B6","side":"#F7A26F"}]
				var opposite = 0;
				var rows_count = 0;
				var inPlay = false;
				var distance = 0;
				var total = 0;
				var targetHeight = $(window).height() + 100
				var resetSpeed = (targetHeight+20)/160;
				var loopSpeed = targetHeight;
				var speed = (targetHeight+20)/160
				var winFlag = false
				var life = 0
				var colorsToUse = 2

				var gameLvl = 1
				var toWin = gameLvl*5
				var remaining = gameLvl*5
				var newLevelRow = false
				var lastCircle = ""

				var special = ""
				var rows_to_special =  Math.floor(Math.random() * 20)+11
				var remaining_to_special = 0

				var progressWidth = 0
				var bestScore = localStorage.getItem("best") ? localStorage.getItem("best") : 0;


				function createRow(row) {
					if(newLevelRow){
						rows_count = rows_count - 1;
						row.removeClass("toActivate").addClass("alert_row table disabled").addClass("falling").removeAttr("id")
						var levelRowIn = $(document.createElement("div")).addClass("cell").html("Level" + gameLvl)
						row.append(levelRowIn)
						game.append(row)
						//Binding gestures
						setTimeout(function(){
							// row.addClass("falling").css({"transition": "transform "+speed+"s linear" , "-webkit-transform": "translateY("+targetHeight+"px)", "-moz-transform": "translateY("+targetHeight+"px)", "transform": "translateY("+targetHeight+"px)"})
							win();
						},200)
						newLevelRow = false
					} else {
						if(remaining_to_special ==  rows_to_special) {
							remaining_to_special = 0;
							rows_to_special =  Math.floor(Math.random() * 30) + 10
							special = "special"
						} else {
							special = ""
						}

						row.addClass(special)

						var color1 = Math.floor(Math.random() * colorsToUse)
						var color3 = Math.floor(Math.random() * colorsToUse)
						if(color3 == color1) {
							// Shitty solution, but array.splice(color1,0) didn't work
							while(color3 == color1){
								color3 = Math.floor(Math.random() * colorsToUse)
							}
						} 
						var colorsSelected = [color1, color3]
						var color2index = Math.floor(Math.random() * colorsSelected.length)
						var color2 = colorsSelected[color2index]


						var curr1 = $(document.createElement("div")).addClass("circleCont")
						var currIn1 = $(document.createElement("div")).addClass("circle").css({"border-color":colorsList[color1].center}).attr("data-target",color1)

						
						var curr2 = $(document.createElement("div")).addClass("circleCont center")
						var currIn2 = $(document.createElement("div")).addClass("circle "+special).css({"border-color":colorsList[color2].center}).attr("data-target",color2).css({"background-color":colorsList[color2].center}).attr("data-target",color2)
						
						var curr3 = $(document.createElement("div")).addClass("circleCont")
						var currIn3 = $(document.createElement("div")).addClass("circle").css({"border-color":colorsList[color3].center}).attr("data-target",color3)
						
						
						curr1.append(currIn1)
						curr2.append(currIn2)
						curr3.append(currIn3)
						row.append(curr1, curr2, curr3)
					}
					

					game.append(row)
				}

				function play(){
					remaining = remaining - 1;
					if( remaining <= 0) {
						newLevelRow = true
						gameLvl++
						toWin = gameLvl*5
						remaining = gameLvl*5

					} else if(remaining <= 1) {
						lastCircle = "last"
					}
					var row = $(document.createElement("div")).addClass(lastCircle + " row toActivate level_"+gameLvl).attr("id",rows_count)
					rows_count++;
					remaining_to_special++;


					if(rows_count%2 == 0) {
						row.addClass("grey")
					}
					// if($(".row").length < 1) {
					// 	row.addClass("active").removeClass("toActivate")
					// }
					
					createRow(row)

					//Binding gestures
					setTimeout(function(){
						row.addClass("falling").css({"transition": "transform "+speed+"s linear" , "-webkit-transform": "translateY("+targetHeight+"px)", "-moz-transform": "translateY("+targetHeight+"px)", "transform": "translateY("+targetHeight+"px)"})
					},200)


				}

				function lost() {
					if(life > 0) {
						life = life-1
						$(".lifeRow").find(".life").eq(0).remove()
					} else {
						inPlay = false
						clearInterval(gameLoop)
						setTimeout(function(){
							if( total > bestScore ) {
								localStorage.setItem("best", total);
							}
							makeFall()
							$(".back").eq(0).css({"transition": "transform "+1.5+"s linear" , "-webkit-transform": "translateY(0px)", "-moz-transform": "translateY(0px)", "transform": "translateY(0px)"})
							$(".row").css({"background-color":"transparent"})
							$(".alert_row").html("")
							$(".finalScore").html(total)
							$(".totalPoints").html(total)
							inPlay = false
							points = 0;
							lvl = 1;
							colorsToUse = 2
							newLevelRow = false
							gameLvl = 1
							toWin = gameLvl*5
							remaining = gameLvl*5
							speed = (targetHeight+20)/160;;
							loopSpeed = targetHeight;
							$(".panelIn").addClass("lost")
							$(".playAgain").show()
							$(".start").hide()
						},200)
					}
					
				}

				function win() {
					inPlay = false;
					if(lvl%3 == 0 && colorsToUse < colorsList.length) {
						colorsToUse++	
					}
					lvl++
					if(life < 3 && lvl%2 == 0) {
						life++
						$(".lifeRow").append("<div class='life'></div>")
					}
					points = 0;
					// if(loopSpeed < 520 && loopSpeed > 320) {
					// 	var k = 0.6/lvl
					// 	loopSpeed = (speed-k) * targetHeight / resetSpeed
					// 	speed = speed - k
					// } else 
					if(loopSpeed < 340) {
						loopSpeed = 320;
						speed = (loopSpeed * resetSpeed / targetHeight);
					} else {
						var k = 1/lvl*2
						loopSpeed = (speed-k) * targetHeight / resetSpeed
						speed = speed - k
					}
					restartLoop()
				}

				function restartLoop(){
					clearInterval(gameLoop)
					if(  $(".row").length ) {
						var elems = $(".row").nextAll(), count = elems.length;
						$(".row").each(function(){
							var nowHeight = targetHeight + $(this).offset().top
							$(this).css({"transition": "transform "+speed+"s linear" , "-webkit-transform": "translateY("+nowHeight+"px)", "-moz-transform": "translateY("+nowHeight+"px)", "transform": "translateY("+nowHeight+"px)"})
							if (!--count) {
								inPlay = true
								gameLoop = setInterval(function(){
											//Calling play function which build the game
											if(inPlay) {
												play()
											}
										},loopSpeed)
							}
						})
					} else {
						inPlay = true;
						gameLoop = setInterval(function(){
									//Calling play function which build the game
									if(inPlay) {
										play()
									}
								},loopSpeed)
					}

					
				}

				function replay(){
					$(".back").eq(0).css({"transition": "transform "+1.5+"s linear" , "-webkit-transform": "translateY(-"+$(window).height()+"px)", "-moz-transform": "translateY(-"+$(window).height()+"px)", "transform": "translateY(-"+$(window).height()+"px)"})
					$(".row").remove()
					$(".lost").removeClass("lost")
					points = 0;
					total = 0;
					lvl = 1;
					life = 0;
					colorsToUse = 2
					newLevelRow = false
					gameLvl = 1
					toWin = gameLvl*5
					remaining = gameLvl*5
					loopSpeed = targetHeight;
					speed = (targetHeight+20)/160;
					restartLoop()
				}

				function stopGame() {
					clearInterval(gameLoop)
					inPlay = false
					$(".row").each(function(){
						var nowHeight = $(this).offset().top + 1
						$(this).css({"transition": "transform "+0+"s linear" , "-webkit-transform": "translateY("+nowHeight+"px)", "-moz-transform": "translateY("+nowHeight+"px)", "transform": "translateY("+nowHeight+"px)"})
					})
					$(".alert_row").each(function(){
						var nowHeight = $(this).offset().top + 1
						$(this).css({"transition": "transform "+0+"s linear" , "-webkit-transform": "translateY("+nowHeight+"px)", "-moz-transform": "translateY("+nowHeight+"px)", "transform": "translateY("+nowHeight+"px)"})
					})
				}

				function goLeft(activeID) {
					var nextID = parseInt(activeID) + 1
					$("#"+activeID).removeClass("active").addClass("disabled").find(".circleCont.center").addClass("transLeft")
					
					if($("#"+nextID).length) {
						$("#"+nextID).removeClass("toActivate").addClass("active")
					}
					
					if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(0).attr("data-target") && !$("#"+activeID).hasClass("special")) {
						points += 1
						total += 1
					} else if($("#"+activeID).hasClass("special")) {
						points += 1
						total += 1
						rainbowEffect()
					} else {
						lost()
					}
				}

				function goRight(activeID) {
					var nextID = parseInt(activeID) + 1
					$("#"+activeID).removeClass("active").addClass("disabled").find(".circleCont.center").addClass("transRight")
					
					if($("#"+nextID).length) {
						$("#"+nextID).removeClass("toActivate").addClass("active")
					}


					console.log(progressWidth)
					if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(2).attr("data-target") && !$("#"+activeID).hasClass("special")) {
						points += 1
						total += 1
					} else if($("#"+activeID).hasClass("special")) {
						points += 1
						total += 1
						rainbowEffect()
					} else {
						lost()
					}
				}

				function makeFall(){
					clearInterval(gameLoop)

					$(".circleCont").each(function(){
						var fallSpeed =  Math.floor(Math.random() * 1.5) + 1
						var floorHeight = $(window).height()
						$(this).css({"transition": "transform "+fallSpeed+"s ease-in" , "-webkit-transform": "translateY("+floorHeight+"px)", "-moz-transform": "translateY("+floorHeight+"px)", "transform": "translateY("+floorHeight+"px)"})
					})
				}

				function rainbowEffect() {
					clearInterval(gameLoop)

					$(".row").each(function(){
						$(this).addClass("disabled").removeClass("active")
					})
					var elems = $(".disabled").nextAll(), count = elems.length;
					total += count
					$(".disabled").each(function(){
						if (!--count) {
							setTimeout(function(){
								makeFall()
								restartLoop();
							},300)
						}
					})


					
				}

				//Set dimensions of game table
				$(".best").html(bestScore)
				$(".panel").eq(0).css({
					"top": ($(window).height()/2) - ($(".panel").height()/2),
					"left": ($(window).width()/2) - ($(".panel").width()/2)
				})
				game.height($(window).height());
				// $(".doArea").eq(0).css({"top":($(window).height()/2)-30})
				// $(".up").eq(0).height($(window).height() - $(".doArea").eq(0).height() - 70)

				//Binding Replay
				$(document).on("click","#replay",function(){
					replay();
				})

				//Binding events Keyboard
				$(document).keydown(function(e){
					var activeID = $(".active").eq(0).attr("id")
					
					if (e.keyCode == 37) { 
						goLeft(activeID)
					}

					if (e.keyCode == 39) { 
						goRight(activeID)
					}
					if (e.keyCode == 13 && !inPlay) {
						replay();
					}
					if (e.keyCode == 32 ) {
						stopGame();
					}
					if (e.keyCode == 82 ) {
						restartLoop()
					}
					if (e.keyCode == 70 ) {
						makeFall()
					}

				})
				
				//Binding events Touch
				$(document).on("swipeleft",function(){
					var activeID = $(".active").eq(0).attr("id")
					goLeft(activeID)
				})

				$(document).on("swiperight", function(){
					var activeID = $(".active").eq(0).attr("id")
					goRight(activeID)
				})


				var gameLoop = setInterval(function(){
					//Calling play function which build the game
					if(inPlay) {
						play()
					}
				},loopSpeed)

				var gameCheck = setInterval(function(){
					if(inPlay){
						//Removing old rows
						if($(".active:not(.disabled)").length) {
							if($(".active:not(.disabled)").eq(0).offset().top >= targetHeight-90) {
								lost()
							}
						}
						//Removing from DOM old rows
						if($(".disabled").length){
							if($(".disabled").eq(0).offset().top >= targetHeight-100) {
								$(".disabled").eq(0).remove()
							}
						}

						if( parseInt($(".totalPoints").html()) != total ) {
							$(".totalPoints").html(total)
						}

						if($(".active").length < 1) {
							$(".row:not(.disabled)").eq(0).removeClass("toActivate").addClass("active")
						}

						if(loopSpeed < 320) {
							inPlay = false;
							loopSpeed = 320;
							speed = (loopSpeed * resetSpeed / targetHeight);
							restartLoop()
						}

						if(rows_to_special%((gameLvl*5)-1) == 0) {
							rows_to_special =  Math.floor(Math.random() * 20)+11
							console.log(rows_to_special)
						}
					}
				}, 100)


			})
</script>
</head>
<body>
	<wrapper>
		<header>
			<div class="progress"></div>
			<div class="logo">
				Colors!
				</div>
			<div class="lifeRow"></div><div class="totalPoints">0</div>
		</header>
		<div class="back">
			<div class="panel">
				<div class=" panelIn cell">
					<div class="playAgain">
						<div class="logo">
								<span class="color1">C</span>
								<span class="color2">o</span>
								<span class="color3">l</span>
								<span class="color4">o</span>
								<span class="color5">r</span>
								<span class="color1">s!</span>
						</div>
						<div class="score">Score</div>
						<div class='finalScore'></div>
						<div class='over_button'>
							<a href='javascript:void(0)' id='replay'>Play Again</a>
						</div>
					</div>
					<div class="start">
						<div class="logo">
							<span class="color1">C</span>
							<span class="color2">o</span>
							<span class="color3">l</span>
							<span class="color4">o</span>
							<span class="color5">r</span>
							<span class="color1">s!</span>
						</div>
						<div class="score">Your Best</div>
						<div class="best"></div>
						<div class='over_button'>
							<a href='javascript:void(0)' id='replay'>Play</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<main id="gameTable">
			<div class="table up"><div class="field cell"></div></div>
			<!-- <div class="doArea"></div> -->
		</main>
		<footer>

		</footer>
	</wrapper>
</body>
</html>
