<!DOCTYPE html>
<html>
<head>
	<title>ColorsGame</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript">
		$(document).bind('mobileinit',function(){
			$.mobile.changePage.defaults.changeHash = false;
			$.mobile.hashListeningEnabled = false;
			$.mobile.pushStateEnabled = false;
		});
	</script>
	<script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
	<!-- <script type="text/javascript" src="js/jquery.touchSwipe.min.js"></script>-->
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link href='https://fonts.googleapis.com/css?family=Lato:400,700,300' rel='stylesheet' type='text/css'>
	<meta charset="utf-8">

	<script type="text/javascript">
		$(document).ready(function(){

				//General Variables
				var cols = 3; //Should be odd
				var rows = Math.floor($(window).height() / 80);
				var game = $("#gameTable").eq(0);
				var lvl = 1;
				var points = 0;
				var toSelect = 0;
				var colorsList =  [{"center":"#F7A7A6","side":"#F48B94"},{"center":"#DBEBC2","side":"#ACDBC9"}, {"center":"#ACC3DB","side":"#ACCADB"}, {"center":"#FFD1B6","side":"#F7A26F"}, {"center":"#EAC2E7","side":"#F989F0"}]
				var opposite = 0;
				var rows_count = 0;
				var inPlay = true;
				var distance = 0;
				var total = 0;
				var targetHeight = $(window).height() + 100
				var resetSpeed = targetHeight/120;
				var loopSpeed = targetHeight;
				var speed = targetHeight/120;
				var winFlag = false
				var life = 0
				var colorsToUse = 2

				var gameLvl = 1
				var toWin = 11
				var remaining = 11
				var newLevelRow = false


				function createRow(row) {
					if(newLevelRow){
						rows_count = rows_count - 1;
						row.removeClass("toActivate").addClass("alert_row table disabled").addClass("falling").removeAttr("id")
						var levelRowIn = $(document.createElement("div")).addClass("cell").html("Level" + gameLvl)
						row.append(levelRowIn)
						game.append(row)
						//Binding gestures
						setTimeout(function(){
							// row.addClass("falling").css({"transition": "transform "+speed+"s linear" , "-webkit-transform": "translateY("+targetHeight+"px)", "-moz-transform": "translateY("+targetHeight+"px)", "transform": "translateY("+targetHeight+"px)"})
							win();
						},200)
						newLevelRow = false
					} else {
						var color1 = Math.floor(Math.random() * colorsToUse)
						var color3 = Math.floor(Math.random() * colorsToUse)
						if(color3 == color1) {
							// Shitty solution, but array.splice(color1,0) didn't work
							while(color3 == color1){
								color3 = Math.floor(Math.random() * colorsToUse)
							}
						} 
						var colorsSelected = [color1, color3]
						var color2index = Math.floor(Math.random() * colorsSelected.length)
						var color2 = colorsSelected[color2index]


						var curr1 = $(document.createElement("div")).addClass("circleCont")
						var currIn1 = $(document.createElement("div")).addClass("circle").css({"border-color":colorsList[color1].center}).attr("data-target",color1)

						var curr2 = $(document.createElement("div")).addClass("circleCont center")
						var currIn2 = $(document.createElement("div")).addClass("circle").css({"border-color":colorsList[color2].center}).attr("data-target",color2).css({"background-color":colorsList[color2].center}).attr("data-target",color2)
						
						var curr3 = $(document.createElement("div")).addClass("circleCont")
						var currIn3 = $(document.createElement("div")).addClass("circle").css({"border-color":colorsList[color3].center}).attr("data-target",color3)
						
						
						curr1.append(currIn1)
						curr2.append(currIn2)
						curr3.append(currIn3)
						row.append(curr1, curr2, curr3)
					}
					

					game.append(row)
				}

				function play(){
					remaining = remaining - 1;
					if( remaining <= 0) {
						newLevelRow = true
						gameLvl++
						toWin = 11
						remaining = 11

					}
					var row = $(document.createElement("div")).addClass("row toActivate level_"+gameLvl).attr("id",rows_count)
					rows_count++;


					if(rows_count%2 == 0) {
						row.addClass("grey")
					}
					if( $(".active").length ) {
						distance = Math.round($(".active").eq(0).offset().top - row.offset().top)
					}
					if($(".row").length < 1) {
						row.addClass("active").removeClass("toActivate")
					}
					
					createRow(row)

					//Binding gestures
					setTimeout(function(){
						row.addClass("falling").css({"transition": "transform "+speed+"s linear" , "-webkit-transform": "translateY("+targetHeight+"px)", "-moz-transform": "translateY("+targetHeight+"px)", "transform": "translateY("+targetHeight+"px)"})
					},200)


				}

				function lost() {
					if(life > 0) {
						life = life-1
						$(".lifeRow").eq(0).remove()
					} else {
						setTimeout(function(){
							clearInterval(gameLoop)
							makeFall()
							$(".row").css({"background-color":"transparent"})
							$(".field").html("<div class='finalScore'>"+total+"</div><div class='over'>GAME OVER</div><div><a href='javascript:void(0)' id='replay'>Play Again</a></div>").css({"transition": "transform "+1.5+"s linear" , "-webkit-transform": "translateY("+(targetHeight-50)+"px)", "-moz-transform": "translateY("+(targetHeight-50)+"px)", "transform": "translateY("+(targetHeight-50)+"px)"})
							inPlay = false
							points = 0;
							lvl = 1;
							colorsToUse = 2
							newLevelRow = false
							gameLvl = 1
							toWin = 11
							remaining = 11
							speed = targetHeight/100;
							loopSpeed = targetHeight;
							$(".up").addClass("lost")
							$(".progress").width("0px")
							total = 0;

						},200)
					}
					
				}

				function win() {
					inPlay = false;
					if(lvl%3 == 0 && colorsToUse < colorsList.length) {
						colorsToUse++	
					}
					$(".progress").width("0px")
					lvl++
					if(life < 3 && lvl%2 == 0) {
						life++
						$(".lifeRow").append("<div class='life'></div>")
					}
					points = 0;
					console.log("Before",loopSpeed, speed)
					if(loopSpeed < 520 && loopSpeed > 320) {
						var k = lvl/8
						loopSpeed = (speed-k) * targetHeight / resetSpeed
						speed = speed - k
					} else if(loopSpeed < 320) {
						loopSpeed = 300;
						speed = (loopSpeed * resetSpeed / targetHeight);
					} else {
						var k = lvl/4
						loopSpeed = (speed-k) * targetHeight / resetSpeed
						speed = speed - k
					}
					console.log("After",loopSpeed, speed)
					restartLoop()
				}

				function restartLoop(){
					clearInterval(gameLoop)
					if(  $(".row").length ) {
						var elems = $(".row").nextAll(), count = elems.length;
						$(".row").each(function(){
							var nowHeight = targetHeight + $(this).offset().top
							$(this).css({"transition": "transform "+speed+"s linear" , "-webkit-transform": "translateY("+nowHeight+"px)", "-moz-transform": "translateY("+nowHeight+"px)", "transform": "translateY("+nowHeight+"px)"})
							if (!--count) {
								inPlay = true
								gameLoop = setInterval(function(){
											//Calling play function which build the game
											if(inPlay) {
												play()
											}
										},loopSpeed)
							}
						})
					} else {
						inPlay = true;
						gameLoop = setInterval(function(){
									//Calling play function which build the game
									if(inPlay) {
										play()
									}
								},loopSpeed)
					}

					
				}

				function replay(){
					$(".field").html("")
					$(".row").remove()
					points = 0;
					total = 0;
					lvl = 1;
					life = 0;
					colorsToUse = 2
					newLevelRow = false
					gameLvl = 1
					toWin = 11
					remaining = 11
					loopSpeed = targetHeight;
					speed = targetHeight/110;
					$(".lost").removeClass("lost")
					$(".progress").width("0px")
					restartLoop()
				}

				function stopGame() {
					clearInterval(gameLoop)
					inPlay = false
					$(".row").each(function(){
						var nowHeight = $(this).offset().top + 1
						$(this).css({"transition": "transform "+0+"s linear" , "-webkit-transform": "translateY("+nowHeight+"px)", "-moz-transform": "translateY("+nowHeight+"px)", "transform": "translateY("+nowHeight+"px)"})
					})
					$(".alert_row").each(function(){
						var nowHeight = $(this).offset().top + 1
						$(this).css({"transition": "transform "+0+"s linear" , "-webkit-transform": "translateY("+nowHeight+"px)", "-moz-transform": "translateY("+nowHeight+"px)", "transform": "translateY("+nowHeight+"px)"})
					})
				}

				function goLeft(activeID) {
					var nextID = parseInt(activeID) + 1
					$("#"+activeID).removeClass("active").addClass("disabled").find(".circleCont.center").addClass("transLeft")
					
					if($("#"+nextID).length) {
						$("#"+nextID).removeClass("toActivate").addClass("active")
					}

					if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(0).attr("data-target")) {
						$(".progress").width( $(".progress").width() + ($(window).width() / (lvl*3)) )
						points += 1
						total += 1
					} else {
						lost()
					}
				}

				function goRight(activeID) {
					var nextID = parseInt(activeID) + 1
					$("#"+activeID).removeClass("active").addClass("disabled").find(".circleCont.center").addClass("transRight")
					
					if($("#"+nextID).length) {
						$("#"+nextID).removeClass("toActivate").addClass("active")
					}

					if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(2).attr("data-target")) {
						$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
						points += 1
						total += 1
					} else {
						lost()
					}
				}

				function makeFall(){
					clearInterval(gameLoop)
					$(".circleCont").each(function(){
						var fallSpeed =  Math.floor(Math.random() * 1.5) + 1
						var floorHeight = $(window).height()
						$(this).css({"transition": "transform "+fallSpeed+"s ease-in" , "-webkit-transform": "translateY("+floorHeight+"px)", "-moz-transform": "translateY("+floorHeight+"px)", "transform": "translateY("+floorHeight+"px)"})
					})
				}

				//Set dimensions of game table
				game.height($(window).height());
				// $(".doArea").eq(0).css({"top":($(window).height()/2)-30})
				$(".up").eq(0).height($(window).height() - $(".doArea").eq(0).height() - 70)

				//Binding Replay
				$(document).on("click","#replay",function(){
					replay();
				})

				//Binding events Keyboard
				$(document).keydown(function(e){
					var activeID = $(".active").eq(0).attr("id")
					
					if (e.keyCode == 37) { 
						goLeft(activeID)
					}

					if (e.keyCode == 39) { 
						goRight(activeID)
					}
					if (e.keyCode == 13 && !inPlay) {
						replay();
					}
					if (e.keyCode == 32 ) {
						stopGame();
					}
					if (e.keyCode == 82 ) {
						restartLoop()
					}
					if (e.keyCode == 70 ) {
						makeFall()
					}

				})
				
				//Binding events Touch
				$(document).on("swipeleft",function(){
					var activeID = $(".active").eq(0).attr("id")
					goLeft(activeID)
				})

				$(document).on("swiperight", function(){
					var activeID = $(".active").eq(0).attr("id")
					goRight(activeID)
				})


				var gameLoop = setInterval(function(){
					//Calling play function which build the game
					if(inPlay) {
						play()
					}
				},loopSpeed)

				var gameCheck = setInterval(function(){
					if(inPlay){
						//Removing old rows
						if($(".active").length) {
							if($(".active").eq(0).offset().top >= targetHeight-100) {
								lost()
							}
						}
						//Removing from DOM old rows
						if($(".disabled").length){
							if($(".disabled").eq(0).offset().top >= targetHeight-100) {
								$(".disabled").eq(0).remove()
							}
						}

						if( parseInt($(".totalPoints").html()) != total ) {
							$(".totalPoints").html(total)
						}

						if($(".active").length < 1) {
							$(".toActivate").eq(0).removeClass("toActivate").addClass("active")
						}

						if(loopSpeed < 300) {
							inPlay = false;
							loopSpeed = 300;
							speed = (loopSpeed * resetSpeed / targetHeight);
							restartLoop()
							console.log(loopSpeed,speed)
						}

					}
				}, 100)


			})
</script>
</head>
<body>
	<wrapper>
		<header>
			<div class="progress"></div>
			<div class="logo">
				<span class="color1" >C</span>
				<span class="color2" >o</span>
				<span class="color3" >l</span>
				<span class="color4" >o</span>
				<span class="color5" >r</span>
				<span class="color1" >s</span>
				<span class="color1" >!</span>
			</div>
			<div class="totalPoints">0</div>
		</header>
		<main id="gameTable">
			<div class="lifeRow"></div>
			<div class="table up"><div class="field cell"></div></div>
			<!-- <div class="doArea"></div> -->
		</main>
		<footer>

		</footer>
	</wrapper>
</body>
</html>
