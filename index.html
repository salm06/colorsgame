<!DOCTYPE html>
<html>
<head>
	<title>ColorsGame</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript">
		$(document).bind('mobileinit',function(){
			$.mobile.changePage.defaults.changeHash = false;
			$.mobile.hashListeningEnabled = false;
			$.mobile.pushStateEnabled = false;
		});
	</script>
	<script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
	<!-- <script type="text/javascript" src="js/jquery.touchSwipe.min.js"></script>-->
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link href='https://fonts.googleapis.com/css?family=Lato:400,700,300' rel='stylesheet' type='text/css'>
	<meta charset="utf-8">

	<script type="text/javascript">
		$(document).ready(function(){

				//General Variables
				var cols = 3; //Should be odd
				var rows = Math.floor($(window).height() / 80);
				var game = $("#gameTable").eq(0);
				var lvl = 1;
				var points = 0;
				var toSelect = 0;
				var colorsList =  [{"center":"#F7A7A6","side":"#F48B94"},{"center":"#DBEBC2","side":"#ACDBC9"}, {"center":"#ACC3DB","side":"#ACCADB"}, {"center":"#FFD1B6","side":"#F7A26F"}, {"center":"#EAC2E7","side":"#F989F0"}]
				var opposite = 0;
				var rows_count = 0;
				var inPlay = true;
				var distance = 0;
				var total = 0;
				var targetHeight = $(window).height() + 100
				var resetSpeed = 7;
				var loopSpeed = targetHeight;
				var speed = targetHeight/120;
				var winFlag = false
				var life = 0
				var colorsToUse = 2

				function createRow(row) {
					var color1 = Math.floor(Math.random() * colorsToUse)
					var color3 = Math.floor(Math.random() * colorsToUse)
					if(color3 == color1) {
						// Shitty solution, but array.splice(color1,0) didn't work
						while(color3 == color1){
								color3 = Math.floor(Math.random() * colorsToUse)
						}
					} 
					var colorsSelected = [color1, color3]
					var color2index = Math.floor(Math.random() * colorsSelected.length)
					var color2 = colorsSelected[color2index]


					var curr1 = $(document.createElement("div")).addClass("circleCont")
					var currIn1 = $(document.createElement("div")).addClass("circle").css({"border-color":colorsList[color1].center}).attr("data-target",color1)

					var curr2 = $(document.createElement("div")).addClass("circleCont center")
					var currIn2 = $(document.createElement("div")).addClass("circle").css({"border-color":colorsList[color2].center}).attr("data-target",color2).css({"background-color":colorsList[color2].center}).attr("data-target",color2)
					
					var curr3 = $(document.createElement("div")).addClass("circleCont")
					var currIn3 = $(document.createElement("div")).addClass("circle").css({"border-color":colorsList[color3].center}).attr("data-target",color3)
					
					
					curr1.append(currIn1)
					curr2.append(currIn2)
					curr3.append(currIn3)
					row.append(curr1, curr2, curr3)

					game.append($(row))
				}

				function play(){
					var row = $(document.createElement("div")).addClass("row level_"+lvl).attr("id",rows_count)
					rows_count++;
					if(rows_count%2 == 0) {
						row.addClass("grey")
					}
					$(".totalPoints").html(total)
					if( $(".active").length ) {
						distance = Math.round($(".active").eq(0).offset().top - row.offset().top)
					}
					if($(".row").length < 1) {
						row.addClass("active")
					}
					
					createRow(row)

					//Binding gestures
					setTimeout(function(){
						row.addClass("falling").css({"transition": "transform "+speed+"s linear" , "-webkit-transform": "translateY("+targetHeight+"px)", "-moz-transform": "translateY("+targetHeight+"px)", "transform": "translateY("+targetHeight+"px)"})
					},200)


				}

				function lost() {
					if(life > 0) {
						life = life-1
						$(".lifeRow").eq(0).remove()
					} else {
						setTimeout(function(){
							clearInterval(gameLoop)
							inPlay = false
							points = 0;
							total = 0;
							lvl = 1;
							colorsToUse = 2
							speed = targetHeight/100;
							loopSpeed = targetHeight;
							$(".row").remove()
							$(".field").html("<div class='over'>GAME OVER</div><div><a href='javascript:void(0)' id='replay'>Play Again</a></div>")
							$(".up").addClass("lost")
							$(".progress").width("0px")

						},200)
					}
					
				}

				function win() {
					clearInterval(gameLoop)
					inPlay = false;
					if(lvl%2 == 0) {
						colorsToUse++	
					}
					$(".progress").width("0px")
					lvl++
					if(life < 3) {
						life++
						$(".lifeRow").append("<div class='life'></div>")
					}
					points = 0;
					if(loopSpeed < 500 && loopSpeed > 260) {
						loopSpeed = 500 - (lvl*25);
						speed = 5 - (lvl*0.25);
					} else if(loopSpeed < 260) {
						loopSpeed = 250;
						speed = 2.5;
					} else {
						loopSpeed = (speed-1) * loopSpeed / speed
						speed = speed - 1
					}
						
					restartLoop()

				}

				function restartLoop(){
					clearInterval(gameLoop)
					$(".level_"+(lvl-1)).each(function(){
							var nowHeight = targetHeight + $(this).offset().top
							$(this).css({"transition": "transform "+speed+"s linear" , "-webkit-transform": "translateY("+nowHeight+"px)", "-moz-transform": "translateY("+nowHeight+"px)", "transform": "translateY("+nowHeight+"px)"})
						})
					
					inPlay = true
					gameLoop = setInterval(function(){
						//Calling play function which build the game
						if(inPlay) {
							play()
						}
					},loopSpeed)
				}

				function replay(){
					$(".field").html("")
					inPlay = true;
					points = 0;
					total = 0;
					lvl = 1;
					life = 0;
					colorsToUse = 2
					loopSpeed = targetHeight;
					speed = targetHeight/110;
					$(".field")
					$(".lost").removeClass("lost")
					$(".progress").width("0px")
					restartLoop()
				}

				//Set dimensions of game table
				game.height($(window).height());
				// $(".doArea").eq(0).css({"top":($(window).height()/2)-30})
				$(".up").eq(0).height($(window).height() - $(".doArea").eq(0).height() - 70).css({"top":"70px"})

				//Binding Replay
				$(document).on("click","#replay",function(){
					replay();
				})

				//Binding events Keyboard
				$(document).keydown(function(e){
					var activeID = $(".active").attr("id")
					if (e.keyCode == 37) { 
						$(".active").eq(0).addClass("disabled").find(".circleCont.center").addClass("transLeft")
						$(".active").removeClass("active")
						$(".row:not(.disabled)").eq(0).addClass("active")
						if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(0).attr("data-target")) {
							$("#"+activeID).removeClass("active")
							if(parseInt($(".done").eq(0).html()) > 0){
								$(".done").eq(0).html(parseInt($(".done").eq(0).html()) - 1)
							}
								$(".totalPoints").html(parseInt($(".totalPoints").html()) + (1*lvl))
								$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
								points += 1
								total += 1
						} else {
							lost()
						}
						return false;
					}

					if (e.keyCode == 39) { 
						$(".active").eq(0).addClass("disabled").find(".circleCont.center").addClass("transRight")
						$(".active").removeClass("active")
						$(".row:not(.disabled)").eq(0).addClass("active")
						if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(2).attr("data-target")) {
							$("#"+activeID).removeClass("active")
							if(parseInt($(".done").eq(0).html()) > 0){
								$(".done").eq(0).html(parseInt($(".done").eq(0).html()) - 1)
							}
								$(".totalPoints").html(parseInt($(".totalPoints").html()) + (1*lvl))
								$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
								points += 1
								total += 1
						} else {
							lost()
						}
						return false;
					}
					if (e.keyCode == 13 && !inPlay) {
						replay();
					}
				})
				
				//Binding events Touch
				$(document).on("swipeleft",function(){
					var activeID = $(".active").attr("id")
					$(".active").eq(0).addClass("disabled").find(".circleCont.center").addClass("transLeft")
					$(".active").removeClass("active")
					$(".row:not(.disabled)").eq(0).addClass("active")
					if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(0).attr("data-target")) {
						$("#"+activeID).removeClass("active")
						if(parseInt($(".done").eq(0).html()) > 0){
							$(".done").eq(0).html(parseInt($(".done").eq(0).html()) - 1)
						}
							$(".totalPoints").html(parseInt($(".totalPoints").html()) + (1*lvl))
							$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
							points += 1
							total += 1
					} else {
						lost()
					}
					return false;
				})

				$(document).on("swiperight", function(){
					var activeID = $(".active").attr("id")
					$(".active").eq(0).addClass("disabled").find(".circleCont.center").addClass("transRight")
					$(".active").removeClass("active")
					$(".row:not(.disabled)").eq(0).addClass("active")
					if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(2).attr("data-target")) {
						$("#"+activeID).removeClass("active")
						if(parseInt($(".done").eq(0).html()) > 0){
							$(".done").eq(0).html(parseInt($(".done").eq(0).html()) - 1)
						}
							$(".totalPoints").html(parseInt($(".totalPoints").html()) + (1*lvl))
							$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
							points += 1
							total += 1
					} else {
						lost()
					}
					return false;
				})


				var gameLoop = setInterval(function(){
					//Calling play function which build the game
					if(inPlay) {
						play()
					}
				},loopSpeed)

				var gameCheck = setInterval(function(){
					if(inPlay){
						//Removing old rows
						if($(".active").length) {
							if($(".active").eq(0).offset().top >= targetHeight-100) {
								lost()
							}
						}
						//Removing from DOM old rows
						if($(".disabled").length){
							if($(".disabled").eq(0).offset().top >= targetHeight-100) {
								$(".disabled").eq(0).remove()
							}
						}
						if(points >= lvl*5) {
							win()
						}
					}
				}, 100)


})
</script>
</head>
<body>
	<wrapper>
		<header>
			<div class="progress"></div>
			<div class="logo">
				<span class="color1" >C</span>
				<span class="color2" >o</span>
				<span class="color3" >l</span>
				<span class="color4" >o</span>
				<span class="color5" >r</span>
				<span class="color1" >s</span>
				<span class="color1" >!</span>
			</div>
			<div class="totalPoints">0</div>
		</header>
		<main id="gameTable">
			<div class="lifeRow"></div>
			<div class="table up"><div class="field cell"></div></div>
			<!-- <div class="doArea"></div> -->
		</main>
		<footer>

		</footer>
	</wrapper>
</body>
</html>
