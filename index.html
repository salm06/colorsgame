<!DOCTYPE html>
<html>
<head>
	<title>ColorsGame</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript">
		$(document).bind('mobileinit',function(){
			$.mobile.changePage.defaults.changeHash = false;
			$.mobile.hashListeningEnabled = false;
			$.mobile.pushStateEnabled = false;
		});
	</script>
	<script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
	<!-- <script type="text/javascript" src="js/jquery.touchSwipe.min.js"></script>-->
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link href='https://fonts.googleapis.com/css?family=Lato:400,700,300' rel='stylesheet' type='text/css'>
	<meta charset="utf-8">

	<script type="text/javascript">
		$(document).ready(function(){

				//General Variables
				var cols = 3; //Should be odd
				var rows = Math.floor($(window).height() / 80);
				var game = $("#gameTable").eq(0);
				var lvl = 1;
				var points = 0;
				var toSelect = 0;
				var colorsArrayCenter = ["#DBEBC2","#F7A7A6"]
				var colorsArraySide = ["#ACDBC9","#F48B94"]
				var opposite = 0;
				var rows_count = 0;
				var inPlay = true;
				var distance = 0;
				var total = 0;
				var targetHeight = $(window).height() + 100
				var loopSpeed = targetHeight;
				var speed = targetHeight/110;
				console.log(targetHeight)

				function play(){
					// if( $(".row").length ) {
					// 	$(".row").each(function(){
					// 		$(".row").css({"transition": "transform "+speed+"s linear", "-webkit-transform": "translateY("+targetHeight+"px)", "-moz-transform": "translateY("+targetHeight+"px)", "transform": "translateY("+targetHeight+"px)"})
					// 	})
					// }

					var row = $(document.createElement("div")).addClass("row level_"+lvl).attr("id",rows_count)
					rows_count++;
					if(rows_count%2 == 0) {
						row.addClass("grey")
					}
					$(".totalPoints").html(total)
					if( $(".active").length ) {
						distance = Math.round($(".active").eq(0).offset().top - row.offset().top)
					}
					if($(".row").length < 1) {
						row.addClass("active")
					}
					for(var c = 0; c < cols; c++) {
						var random = Math.round(Math.random() * 1) + 0

						if(c == 0 && random == 0) {
							opposite = 1;
						} else if(c == 0 && random == 1) {
							opposite = 0;
						}

						var curr = $(document.createElement("div")).addClass("circleCont")

						if(c == cols-1) {
							var currIn = $(document.createElement("div")).addClass("circle").css({"border-color":colorsArraySide[opposite]}).attr("data-target",opposite)
						} else {
							var currIn = $(document.createElement("div")).addClass("circle").css({"border-color":colorsArraySide[random]}).attr("data-target",random)
						}
						if(c == Math.floor(cols/2)) {
							curr.addClass("center")
							currIn.css({"background-color":colorsArrayCenter[random]}).attr("data-target",random)
						} 

						
						
						curr.append(currIn)
						row.append(curr)
						
					}
					//Appending Row
					game.append($(row))

					//Set new speed to all
					$(".row").each(function(){
						var computedPosition = $(this).offset().top
						$(this).stop().animate({top: (computedPosition+targetHeight)+"px"}, speed*1000, "linear")
					})
					// .css({"-webkit-transform": "translateY("+targetHeight+"px)", "-moz-transform": "translateY("+targetHeight+"px)", "transform": "translateY("+targetHeight+"px)"})

				}

				function lost() {
					setTimeout(function(){
						clearInterval(gameLoop)
						inPlay = false
						points = 0;
						total = 0;
						lvl = 1;
						speed = targetHeight/100;
						loopSpeed = targetHeight;
						$(".row").remove()
						$(".field").html("<div class='over'>GAME OVER</div><div><a href='javascript:void(0)' id='replay'>Play Again</a></div>")
						$(".up").addClass("lost")
						$(".progress").width("0px")

						},200)
				}

				function win() {
						$(".progress").width("0px")
						points = 0;
						lvl++
						if(loopSpeed < 500 && loopSpeed > 250) {
							loopSpeed = 500 - (lvl*25);
							speed = 5 - (lvl*0.25);
						} else if(loopSpeed < 250) {
							loopSpeed = 250;
							speed = 2.5;
						} else {
							loopSpeed = (speed-1) * loopSpeed / speed
							speed = speed - 1
						}

						console.log(loopSpeed, speed, loopSpeed < 250)
						restartLoop()
				}

				function restartLoop(){
					clearInterval(gameLoop)
					gameLoop = setInterval(function(){
							//Calling play function which build the game
							if(inPlay) {
								play()
							}
						},loopSpeed)
				}

				function replay(){
					inPlay = true;
					points = 0;
					total = 0;
					lvl = 1;
					$(".done").eq(0).html("20")
					$(".field").html("")
					$(".lost").removeClass("lost")
					$(".progress").width("0px")
					restartLoop()
				}

				//Set dimensions of game table
				game.height($(window).height());
				// $(".doArea").eq(0).css({"top":($(window).height()/2)-30})
				$(".up").eq(0).height($(window).height() - $(".doArea").eq(0).height() - 70).css({"top":"70px"})

				//Binding Replay
				$(document).on("click","#replay",function(){
					replay();
				})

				//Binding events Keyboard
				$(document).keydown(function(e){
					var activeID = $(".active").attr("id")
					if (e.keyCode == 37) { 
						$(".active").eq(0).addClass("disabled").find(".circleCont.center").addClass("transLeft")
						$(".active").removeClass("active")
						$(".row:not(.disabled)").eq(0).addClass("active")
						if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(0).attr("data-target")) {
							$("#"+activeID).removeClass("active")
							if(parseInt($(".done").eq(0).html()) > 0){
								$(".done").eq(0).html(parseInt($(".done").eq(0).html()) - 1)
							}
							if(points >= 20) {
								win()
								return false;
							} else {
								$(".totalPoints").html(parseInt($(".totalPoints").html()) + (1*lvl))
								$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
								points += 1
								total += 1*lvl
							}
						} else {
							lost()
						}
						return false;
					}

					if (e.keyCode == 39) { 
						$(".active").eq(0).addClass("disabled").find(".circleCont.center").addClass("transRight")
						$(".active").removeClass("active")
						$(".row:not(.disabled)").eq(0).addClass("active")
						if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(2).attr("data-target")) {
							$("#"+activeID).removeClass("active")
							if(parseInt($(".done").eq(0).html()) > 0){
								$(".done").eq(0).html(parseInt($(".done").eq(0).html()) - 1)
							}
							if(points >= 20) {
								win()
								return false;
							} else {
								$(".totalPoints").html(parseInt($(".totalPoints").html()) + (1*lvl))
								$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
								points += 1
								total += 1*lvl
							}
						} else {
							lost()
						}
						return false;
					}
					if (e.keyCode == 13 && !inPlay) {
						replay();
					}
				})
				
				//Binding events Touch
				$(document).on("swipeleft",function(){
					var activeID = $(".active").attr("id")
					$(".active").eq(0).addClass("disabled").find(".circleCont.center").addClass("transLeft")
					$(".active").removeClass("active")
					$(".row:not(.disabled)").eq(0).addClass("active")
					if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(0).attr("data-target")) {
						$("#"+activeID).removeClass("active")
						if(parseInt($(".done").eq(0).html()) > 0){
							$(".done").eq(0).html(parseInt($(".done").eq(0).html()) - 1)
						}
						if(points >= 20) {
							win()
							return false;
						} else {
							$(".totalPoints").html(parseInt($(".totalPoints").html()) + (1*lvl))
							$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
							points += 1
							total += 1*lvl
						}
					} else {
						lost()
					}
					return false;
				})

				$(document).on("swiperight", function(){
					var activeID = $(".active").attr("id")
					$(".active").eq(0).addClass("disabled").find(".circleCont.center").addClass("transRight")
					$(".active").removeClass("active")
					$(".row:not(.disabled)").eq(0).addClass("active")
					if($("#"+activeID).find(".circle").eq(1).attr("data-target") == $("#"+activeID).find(".circle").eq(2).attr("data-target")) {
						$("#"+activeID).removeClass("active")
						if(parseInt($(".done").eq(0).html()) > 0){
							$(".done").eq(0).html(parseInt($(".done").eq(0).html()) - 1)
						}
						if(points >= 20) {
							win()
							return false;
						} else {
							$(".totalPoints").html(parseInt($(".totalPoints").html()) + (1*lvl))
							$(".progress").width( $(".progress").width() + ($(window).width() / 20) )
							points += 1
							total += 1*lvl
						}
					} else {
						lost()
					}
					return false;
				})


				var gameLoop = setInterval(function(){
					//Calling play function which build the game
					if(inPlay) {
						play()
					}
				},loopSpeed)

				var gameCheck = setInterval(function(){
					if(inPlay){
						//Removing old rows
						if($(".active").length) {
							if($(".active").eq(0).offset().top >= targetHeight-100) {
								lost()
							}
						}
						//Removing from DOM old rows
						if($(".disabled").length){
							if($(".disabled").eq(0).offset().top >= targetHeight-100) {
								$(".disabled").eq(0).remove()
							}
						}
					}
				}, 100)


})
</script>
</head>
<body>
	<wrapper>
		<header>
			<div class="progress"></div>
			<div class="logo">
				<span class="color1" >C</span>
				<span class="color2" >o</span>
				<span class="color3" >l</span>
				<span class="color4" >o</span>
				<span class="color5" >r</span>
				<span class="color1" >s</span>
				<span class="color1" >!</span>
			</div>
			<div class="totalPoints">0</div>
		</header>
		<main id="gameTable">
			<div class="table up"><div class="field cell"></div></div>
			<!-- <div class="doArea"></div> -->
		</main>
		<footer>

		</footer>
	</wrapper>
</body>
</html>
